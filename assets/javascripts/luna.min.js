(function(b,a){a.Luna={removePerson:function(c){b(c).parent().remove();return false},addBeneficiary:function(d,c){var f=b("<div>").html(c).text();var j=b("ul#luna-beneficiaries");if(j.children("li."+d).length==0){var e=b("<li>").addClass(d).html(f);var k=b("<select>").attr("name","users["+d+"]");var l=j.data("levels");for(var g=0;g<l.length;g++){var h=b("<option>").attr("value",l[g].value).html(l[g].name);k.append(h)}e.append(k);j.append(e)}},getFilterNames:function(){var d=b("#luna-newfilter");var c=b("#luna-newfilter-name");var e=b("#luna-newfilter-config");b.ajax({url:d.data("filternames-url"),dataType:"json",beforeSend:function(g,f){d.removeClass("hidden-js");c.html(b("<img>").attr("width",16).attr("height",16).attr("src",a.ASSETS_URL+"images/ajax-indicator-black.svg"))},success:function(g){d.addClass("newfilter");var f=b("<select>").attr("name","field").on("change",function(){b.ajax({url:b("#luna-newfilter").data("filterdata-url"),data:{field:b('select[name="field"] option:selected').val()},dataType:"json",beforeSend:function(j,i){e.html(b("<img>").attr("width",16).attr("height",16).attr("src",a.ASSETS_URL+"images/ajax-indicator-black.svg"))},success:function(l){var m=l.compare;var k=b("<select>").attr("name","compare");b.each(m,function(n,o){var p=b("<option>").attr("value",n).html(o);k.append(p)});var j=l.values;var i=b("<select>").attr("name","value");b.each(j,function(n,p){var o=b("<option>").attr("value",n).html(p);i.append(o)});e.html("");e.append(k);e.append(i);b('button[name="apply"]').removeClass("hidden-js")}})});var h=b("<option>").attr("value","").html("-- "+d.data("pleasechoose")+" --");f.append(h);b.each(g,function(i,k){var j=b("<option>").attr("value",i).html(k);f.append(j)});c.html(f)}})},removeFilter:function(d){b(d).parent().remove();var c=b("#luna-applied-filters");c.data("filter-count",c.data("filter-count")-1);if(c.children("span.luna-filter").length==0){c.addClass("hidden-js")}a.Luna.loadPersons()},loadFilterPreset:function(){var e=b("#luna-userfilter-preset");if(e.children("option:selected").attr("value")!=""){var c=e.data("update-url").split("?");var d=c[0]+"/"+e.children("option:selected").attr("value");if(c[1]!=""){d+="?"+c[1]}b.ajax({url:d,dataType:"html",beforeSend:function(g,f){b("div#luna-applied-filters").html(b("<img>").attr("width",32).attr("height",32).attr("src",a.ASSETS_URL+"images/ajax-indicator-black.svg"))},success:function(g){var f=b("div#luna-applied-filters");f.html(g);f.removeClass("hidden-js");a.Luna.loadPersons(0)}})}},loadPersons:function(e){var f=b("#luna-data");var c=b(f).data("update-url").split("?");var d=c[0]+"/"+e;if(c[1]!=""){d+="?"+c[1]}b.ajax({url:d,data:b('input[type="hidden"][name*="filters["]').serialize(),dataType:"html",beforeSend:function(h,g){f.html(b("<img>").attr("width",64).attr("height",64).attr("src",a.ASSETS_URL+"images/ajax-indicator-black.svg"))},success:function(g){f.html(g)}});return false},addTag:function(d){var h=b("div#luna-person-tags");if(h.children("div#luna-tag-"+d).length==0){var c=b("<div>").addClass("luna-tag").attr("id","luna-tag-"+d).html(d);var g=b("<input>").attr("type","hidden").attr("name","tags[]").attr("value",d);var e=b("<a>").attr("href","").addClass("luna-tag-remove").on("click",function(){a.Luna.removeTag(this);return false});var f=b("<img>").attr("src",a.ASSETS_URL+"images/icons/blue/trash.svg").attr("width","16").attr("height","16").addClass("icon-role-clickable").addClass("icon-role-trash");e.append(f);c.append(g);c.append(e);h.append(c)}},removeTag:function(c){b(c).parent().remove()},remove_attachment:function(){jQuery.ajax({url:a.ABSOLUTE_URI_STUDIP+"dispatch.php/messages/delete_attachment",data:{document_id:jQuery(this).closest("li").data("document_id"),message_id:jQuery(this).closest("form").find("input[name=message_id]").val()},type:"POST"});jQuery(this).closest("li").fadeOut(300,function(){jQuery(this).remove()})},prepareFileUpload:function(f){var h=b("ul#luna-newdocs");for(var g=0;g<f.files.length;g++){var c=b("<li>");var j=b("<input>").attr("type","hidden").attr("name","newdocs[]").attr("value",f.files[g].name);var k=b(document.createTextNode(f.files[g].name));var d=b("<a>").on("click",function(i){b(this).parent().remove()});var e=b("<img>").attr("src",a.ASSETS_URL+"images/icons/blue/trash.svg").attr("width","16").attr("height","16").addClass("icon-role-clickable").addClass("icon-role-trash");h.append(c.append(j).append(k).append(d.append(e)))}},init:function(){b("#luna-add-filter").on("click",function(){a.Luna.getFilterNames();return false});b("#luna-userfilter-preset").on("change",function(){a.Luna.loadFilterPreset();return false});b("a.luna-tag-remove").on("click",function(){a.Luna.removeTag(this);return false});var c=b('input[name="tag"]');b("a.luna-tag-add").on("click",function(){a.Luna.addTag(c.val());c.val("");return false});c.autocomplete({source:c.data("available-tags"),minLength:2,select:function(d,e){a.Luna.addTag(e.item.value);c.val("")}});c.on("keypress",function(e){var d=(e.keyCode?e.keyCode:e.which);if(d=="13"){e.preventDefault();a.Luna.addTag(c.val());c.val("")}});b('input[name="docs[]"]').on("change",function(d){a.Luna.prepareFileUpload(this)})}};b(document).ready(function(){a.Luna.init();b(document).on("dialog-open",function(){a.Luna.init()});if(b("div#luna-data").length>0){a.Luna.loadPersons(0)}})}(jQuery,STUDIP));